---
sidebar_position: 2
---

Elastic Stack (ELK)
===================

Setup
-----

### Authenticating to AWS

Before we can build the AMI, we need to provide our AWS credentials to Packer. These credentials have permissions to
create, modify and delete EC2 instances.

To allow Packer to access our IAM user credentials, set our AWS access key ID and secret key as environment variables:

```bash
export AWS_ACCESS_KEY_ID="<YOUR_AWS_ACCESS_KEY_ID>"
export AWS_SECRET_ACCESS_KEY="<YOUR_AWS_SECRET_ACCESS_KEY>"
```

Alternatively, we can put the two lines above in a shell script like:

```shell
#!/bin/bash

export AWS_ACCESS_KEY_ID="<YOUR_AWS_ACCESS_KEY_ID>"
export AWS_SECRET_ACCESS_KEY="<YOUR_AWS_SECRET_ACCESS_KEY>"
```

and [source it](https://serverfault.com/a/336282)

### Preparing for Building Image

Create a file named **aws-elk.auto.pkrvars.hcl** under _packer/elk/images_ directory. Example:

```hcl
aws_image_region           = "us-east-2"
elastic_user_passwd        = "2324fJGY2sdHDde2ubu"
ssl_cert_file_path         = "/absolute/path/to/server.crt"
ssl_cert_key_file_path     = "/absolute/path/to/server.key"
ssl_nginx_config_file_path = "/absolute/path/to/nginx-ssl.conf"
```

#### SSL certificate

The **ssl_cert_file_path** and **ssl_cert_key_file_path** above are paths to SSL certificate file and SSL certificate
key, respectively. They can be [obtained via Certbot](https://qubitpi.github.io/aergia/blog/certbot)

##### Nginx Config

:::note

Replace `my-domain.com` with the domain backed by the [SSL](#ssl-certificate)

:::

```text
server {
	listen 80 default_server;
	listen [::]:80 default_server;

	root /var/www/html;

	index index.html index.htm index.nginx-debian.html;

	server_name _;

	location / {
		try_files $uri $uri/ =404;
	}
}

server {
	root /var/www/html;

	index index.html index.htm index.nginx-debian.html;
    server_name my-domain.com;

	location / {
		proxy_pass http://localhost:5601;
	}

    listen [::]:443 ssl ipv6only=on;
    listen 443 ssl;
    ssl_certificate /etc/ssl/certs/server.crt;
    ssl_certificate_key /etc/ssl/private/server.key;
}

server {
    if ($host = my-domain.com) {
        return 301 https://$host$request_uri;
    }

	listen 80 ;
	listen [::]:80 ;
    server_name my-domain.com;
    return 404;
}
```

#### Building Image

```bash
packer init .
packer fmt .
packer validate .
packer build .
```

Record the password at command line prompt. For example

```shell
==> install-elk.amazon-ebs.elk: + sudo /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
==> install-elk.amazon-ebs.elk: + yes
    install-elk.amazon-ebs.elk: This tool will reset the password of the [elastic] user to an autogenerated value.
    install-elk.amazon-ebs.elk: The password will be printed in the console.
    install-elk.amazon-ebs.elk:
    install-elk.amazon-ebs.elk:
    install-elk.amazon-ebs.elk: Password for the [elastic] user successfully reset.
    install-elk.amazon-ebs.elk: New value: dsrg34IKHU787iud=dio
```

In this case, the password is `dsrg34IKHU787iud=dio` which is shown in the last line of the output above.


```shell
==> Wait completed after 5 minutes 40 seconds

==> Builds finished. The artifacts of successful builds are:
--> install-elk.amazon-ebs.elk: AMIs were created:
<sensitive>: ami-34gfg45herr356hre43g
```

#### Terraform EC2

```bash
terraform init
terraform validate

```