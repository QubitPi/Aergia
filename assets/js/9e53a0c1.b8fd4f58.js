"use strict";(self.webpackChunkhashicorp_aws=self.webpackChunkhashicorp_aws||[]).push([[6899],{9426:(e,i,s)=>{s.r(i),s.d(i,{assets:()=>o,contentTitle:()=>t,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var n=s(5893),a=s(1151);const r={sidebar_position:6,title:"Jersey-Jetty Based Webservice"},t=void 0,l={id:"webservice",title:"Jersey-Jetty Based Webservice",description:"[//]: # (Copyright Jiaqi Liu)",source:"@site/docs/6-webservice.md",sourceDirName:".",slug:"/webservice",permalink:"/hashicorp-aws/docs/webservice",draft:!1,unlisted:!1,editUrl:"https://github.com/QubitPi/hashicorp-aws/tree/master/docs/docs/6-webservice.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6,title:"Jersey-Jetty Based Webservice"},sidebar:"tutorialSidebar",previous:{title:"React App",permalink:"/hashicorp-aws/docs/react"},next:{title:"Configuration Management for Immutable Infrastructure",permalink:"/hashicorp-aws/docs/IaC-configuration-management"}},o={},c=[{value:"Manual Deployment",id:"manual-deployment",level:2},{value:"GitHub Action Automatic Deployment",id:"github-action-automatic-deployment",level:2},{value:"General Template in Downstream Repo",id:"general-template-in-downstream-repo",level:3},{value:"Auxiliary Actions",id:"auxiliary-actions",level:3},{value:"JDK 17 Setup",id:"jdk-17-setup",level:4},{value:"Jersey Webservice Template (JPA through Elide)",id:"jersey-webservice-template-jpa-through-elide",level:4},{value:"Installing Data Models",id:"installing-data-models",level:5},{value:"Docker Compose",id:"docker-compose",level:5},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"The Webservice was Running Properly Right After Deployment, but NOT After a While with &quot;503 Service Unavailable&quot;",id:"the-webservice-was-running-properly-right-after-deployment-but-not-after-a-while-with-503-service-unavailable",level:3}];function h(e){const i={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",h5:"h5",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(i.admonition,{type:"tip",children:(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsx)(i.li,{children:"Yes, we DO NOT support Spring, never ever"}),"\n",(0,n.jsxs)(i.li,{children:["EBS volumes during build time will ",(0,n.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-packer/packer/integrations/hashicorp/amazon/latest/components/builder/ebs#:~:text=Optional%3A-,delete_on_termination,-(bool)%20%2D%20Indicates%20whether",children:"automatically be removed"})]}),"\n"]})}),"\n",(0,n.jsx)(i.h2,{id:"manual-deployment",children:"Manual Deployment"}),"\n",(0,n.jsx)(i.p,{children:"The following script variables need to be defined:"}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:[(0,n.jsx)(i.a,{href:"https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-envvars.html",children:(0,n.jsx)(i.strong,{children:"AWS_ACCESS_KEY_ID"})})," & ",(0,n.jsx)(i.a,{href:"https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-envvars.html",children:(0,n.jsx)(i.strong,{children:"AWS_SECRET_ACCESS_KEY"})})]}),"\n",(0,n.jsxs)(i.admonition,{type:"info",children:[(0,n.jsxs)(i.p,{children:["The ",(0,n.jsx)(i.em,{children:"IAM user"})," associated with the credentials above must have the following ",(0,n.jsx)(i.a,{href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction_access-management.html",children:"AWS permissions policies"}),":"]}),(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsx)(i.li,{children:"IAMFullAccess"}),"\n",(0,n.jsx)(i.li,{children:"AmazonEC2FullAccess"}),"\n",(0,n.jsx)(i.li,{children:"AmazonRoute53FullAccess"}),"\n"]})]}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:[(0,n.jsx)(i.strong,{children:"WS_DIR"}),": The local absolute path to the webservice repo"]}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:[(0,n.jsx)(i.strong,{children:"HC_DIR"}),": The local absolute path to the ",(0,n.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-aws/",children:"hashicorp-aws"})," directory"]}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:[(0,n.jsx)(i.strong,{children:"HC_PACKER_VAR_FILE"}),": The local absolute path to the ",(0,n.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-packer/packer/guides/hcl/variables#from-a-file",children:"HashiCorp Packer variable file"})]}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:[(0,n.jsx)(i.strong,{children:"HC_TF_VAR_FILE"}),": The local absolute path to the ",(0,n.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-terraform/terraform/language/values/variables#variable-definitions-tfvars-files",children:"HashiCorp Terraform variable file"})]}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:[(0,n.jsx)(i.strong,{children:"HC_CONFIG_DIR"}),": The local absolute path to a directory containing the following deployment files:"]}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:["SSL cert file located (",(0,n.jsx)(i.code,{children:"/abs/path/to/hashicorp-aws-config-dir/server.crt"}),")"]}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:["SSL cert key file (",(0,n.jsx)(i.code,{children:"/abs/path/to/hashicorp-aws-config-dir/server.key"}),")"]}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:["Nginx config file (",(0,n.jsx)(i.code,{children:"/abs/path/to/hashicorp-aws-config-dir/nginx.conf"}),")"]}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:["ELK Filebeat config file (",(0,n.jsx)(i.code,{children:"/abs/path/to/hashicorp-aws-config-dir/filebeat.yml"}),")"]}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:["Any webservice ",(0,n.jsx)(i.strong,{children:".properties"})," files (",(0,n.jsx)(i.code,{children:"/abs/path/to/hashicorp-aws-config-dir"}),")"]}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:["A ",(0,n.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-packer/packer/guides/hcl/variables#from-a-file",children:"HashiCorp Packer variable file"})," named ",(0,n.jsx)(i.strong,{children:"aws-ws.pkrvars.hcl"})," with the following variable values\n(",(0,n.jsx)(i.code,{children:"/abs/path/to/hashicorp-aws-config-dir/aws-ws.pkrvars.hcl"}),"):"]}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-hcl",children:'aws_image_region                 = "my-aws-region"\nami_name                         = "my-webservice"\ninstance_type                    = "<one of t2.micro/t2.small/t2.medium/t2.large/t2.xlarge/t2.2xlarge>"\nws_war_path                      = "path/to/my-webservice-1.0-SNAPSHOT.war"\naws_ws_ssl_cert_file_path        = "path/to/server.crt"\naws_ws_ssl_cert_key_file_path    = "path/to/server.key"\naws_ws_nginx_config_file_path    = "path/to/nginx.conf"\naws_ws_filebeat_config_file_path = "path/to/filebeat.yml"\n'})}),"\n"]}),"\n",(0,n.jsxs)(i.li,{children:["\n",(0,n.jsxs)(i.p,{children:["A ",(0,n.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-terraform/terraform/language/values/variables#variable-definitions-tfvars-files",children:"HashiCorp Terraform variable file"})," named ",(0,n.jsx)(i.strong,{children:"aws-ws.tfvars"})," with the following variable values\n(",(0,n.jsx)(i.code,{children:"/abs/path/to/hashicorp-aws-config-dir/aws-ws.tfvars"}),"):"]}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-hcl",children:'aws_deploy_region   = "my-aws-region"\nami_name            = "my-webservice"\ninstance_type       = "<one of t2.micro/t2.small/t2.medium/t2.large/t2.xlarge/t2.2xlarge>"\nec2_instance_name   = "My Webservice"\nec2_security_groups = ["My Webservice"]\nroute_53_zone_id    = "9DQXLTNSN7ZX9P8V2KZII"\nws_domain           = "mywebservice.mycompany.com"\nsentry_dsn          = "can be empty if sentry.io is not needed"\n'})}),"\n",(0,n.jsx)(i.admonition,{type:"info",children:(0,n.jsxs)(i.p,{children:["Although the ",(0,n.jsx)(i.code,{children:"ws_domain"})," is a public identity, ",(0,n.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-aws/",children:"hashicorp-aws"})," will bind a ",(0,n.jsx)(i.strong,{children:"private IP"})," address to this domain,\nbecause webservice tend to be deployed in a virtual private network and AWS also requires\n",(0,n.jsx)(i.a,{href:"https://serverfault.com/a/967483",children:"EC2 instances of different Security Groups to communicate through private IP"})]})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(i.p,{children:["Then we can execute the ",(0,n.jsx)(i.strong,{children:(0,n.jsx)(i.a,{href:"https://github.com/QubitPi/hashicorp-aws/blob/master/hashicorp/webservice/deploy.sh",children:"deploy.sh"})})," to manually deploy any Jersey-Jetty based webservice."]}),"\n",(0,n.jsx)(i.h2,{id:"github-action-automatic-deployment",children:"GitHub Action Automatic Deployment"}),"\n",(0,n.jsx)(i.h3,{id:"general-template-in-downstream-repo",children:"General Template in Downstream Repo"}),"\n",(0,n.jsx)(i.admonition,{type:"info",children:(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsx)(i.li,{children:"Java 17 is assumed in the example below"}),"\n",(0,n.jsxs)(i.li,{children:["Assuming ws dir is called ",(0,n.jsx)(i.strong,{children:"my-webservice"})]}),"\n",(0,n.jsx)(i.li,{children:"~/.m2/settings.xml is working on CI/CD server"}),"\n"]})}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-yaml",children:"jobs:\n  hashicorp:\n    name: Generated WS WAR in GitHub Action, publish its AMI and deploy the AMI to EC2 through HashiCorp\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v3\n      - name: Set up JDK 17\n        uses: actions/setup-java@v3\n        with:\n          java-version: '17'\n          distribution: 'adopt'\n      - name: Checkout HashiCorp deployment tool\n        run: git clone https://github.com/QubitPi/hashicorp-aws.git ../hashicorp-aws\n      - name: Load hashicorp-aws-config-dir and put it in the same directory as hashicorp-aws\n        run: ...\n      - name: Load Packer variable file\n        run: cp ../hashicorp-aws-config-dir/aws-ws.pkrvars.hcl ../hashicorp-aws/hashicorp/webservice/images/aws-ws.auto.pkrvars.hcl\n      - name: Load Terraform variable file\n        run: cp ../hashicorp-aws-config-dir/aws-ws.tfvars ../hashicorp-aws/hashicorp/webservice/instances/aws-ws.auto.tfvars\n      - name: Generate webservice WAR file\n        run: mvn -B clean package\n      - name: Move WAR file to a location for HashiCorp deployment to pickup\n        run: mv target/my-webservice-1.0-SNAPSHOT.war ../hashicorp-aws/hashicorp/webservice/images/\n      - name: QubitPi/hashicorp-aws\n        if: github.ref == 'refs/heads/master'\n        uses: QubitPi/hashicorp-aws@master\n        with:\n          hashicorp-dir: ../hashicorp-aws/hashicorp/webservice\n          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}\n          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}\n          aws-region: ${{ secrets.AWS_REGION }}\n"})}),"\n",(0,n.jsx)(i.h3,{id:"auxiliary-actions",children:"Auxiliary Actions"}),"\n",(0,n.jsx)(i.h4,{id:"jdk-17-setup",children:"JDK 17 Setup"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-yaml",children:"---\nname: My CI/CD\n\njobs:\n  my-job:\n    name: My job name\n    runs-on: ubuntu-latest\n    steps:\n      - uses: QubitPi/hashicorp-aws/auxiliary/github/actions/jdk-setup@master\n"})}),"\n",(0,n.jsx)(i.h4,{id:"jersey-webservice-template-jpa-through-elide",children:"Jersey Webservice Template (JPA through Elide)"}),"\n",(0,n.jsx)(i.h5,{id:"installing-data-models",children:"Installing Data Models"}),"\n",(0,n.jsx)(i.admonition,{type:"info",children:(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"model-package-jar-group-id"}),' is the Maven group ID of JAR containing data models, e.g. "com.myorg"']}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"model-package-jar-artifact-id"}),' is the Maven artifact ID of JAR containing data models, e.g. "my-data-models"']}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"model-package-jar-version"}),' is the version of JAR containing data models, e.g. "3.1.7"']}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"model-repo-org"})," is the data models repo owner, e.g. paion-data. This can be eigher a GitHub user account name or\na GitHub organization name"]}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"models-repo-name"})," is the data models repo name, e.g. my-data-models"]}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"models-repo-token"}),' is the GitHub Fine-grained token with at least "Read access to code and metadata" repository\npermissions to the data models repo']}),"\n"]})}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-yaml",children:"---\nname: My CI/CD\n\njobs:\n  my-job:\n    name: My job name\n    runs-on: ubuntu-latest\n    steps:\n      - uses: QubitPi/hashicorp-aws/auxiliary/github/actions/jersey-webservice-template/jpa-elide/install-data-models@master\n        with:\n          model-package-jar-group-id: com.myorg\n          model-package-jar-artifact-id: my-data-models\n          model-package-jar-version: 1.0.0\n          model-repo-org: myorg\n          models-repo-name: my-data-models\n          models-repo-token: ${{ secrets.ASTRAIOS_DATA_MODELS_REPO_TOKEN }}\n"})}),"\n",(0,n.jsx)(i.h5,{id:"docker-compose",children:"Docker Compose"}),"\n",(0,n.jsxs)(i.admonition,{type:"info",children:[(0,n.jsx)(i.p,{children:"Required parameters:"}),(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"webservice-repo-clone-url"})," is the git clone URL of the GitHub repo generated by ",(0,n.jsx)(i.a,{href:"https://qubitpi.github.io/jersey-webservice-template/",children:"jersey-webservice-template"})]}),"\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"model-package"})," is the\n",(0,n.jsx)(i.a,{href:"https://github.com/QubitPi/jersey-webservice-template-jpa-data-model/blob/master/src/main/java/com/qubitpi/ws/jersey/template/models/Book.java#L16",children:"fully qualified name of the package containing all JPA models"})]}),"\n"]}),(0,n.jsx)(i.p,{children:"Optional parameters:"}),(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsxs)(i.li,{children:[(0,n.jsx)(i.strong,{children:"oauth-enabled"})," flags whether or not to enable ",(0,n.jsx)(i.a,{href:"https://qubitpi.github.io/jersey-webservice-template/apidocs/com/qubitpi/ws/jersey/template/web/filters/OAuthFilter.html",children:"OAuthFilter"})," container request filter. Default is ",(0,n.jsx)(i.code,{children:"false"})]}),"\n"]})]}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-yaml",children:"---\nname: My CI/CD\n\njobs:\n  my-job:\n    name: My job name\n    runs-on: ubuntu-latest\n    steps:\n      - uses: QubitPi/hashicorp-aws/auxiliary/github/actions/jersey-webservice-template/jpa-elide/docker-compose@master\n        with:\n          webservice-repo-clone-url: https://github.com/QubitPi/jersey-webservice-template.git\n          model-package: ${{ secrets.MODEL_PACKAGE_NAME }}\n"})}),"\n",(0,n.jsx)(i.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,n.jsx)(i.h3,{id:"the-webservice-was-running-properly-right-after-deployment-but-not-after-a-while-with-503-service-unavailable",children:'The Webservice was Running Properly Right After Deployment, but NOT After a While with "503 Service Unavailable"'}),"\n",(0,n.jsxs)(i.p,{children:["This could be the resource starvation on EC2 instance. Please try using a bigger EC2 sizes. For example, bumping\n",(0,n.jsx)(i.em,{children:"t2.micro"})," to ",(0,n.jsx)(i.em,{children:"t2.medium"}),". ",(0,n.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-aws/",children:"hashicorp-aws"})," currently supports ",(0,n.jsx)(i.strong,{children:"t2.x"})," sizes, i.e. one of the following sizes can be\nselected:"]}),"\n",(0,n.jsxs)(i.ul,{children:["\n",(0,n.jsx)(i.li,{children:"t2.micro"}),"\n",(0,n.jsx)(i.li,{children:"t2.small"}),"\n",(0,n.jsx)(i.li,{children:"t2.medium"}),"\n",(0,n.jsx)(i.li,{children:"t2.large"}),"\n",(0,n.jsx)(i.li,{children:"t2.xlarge"}),"\n",(0,n.jsx)(i.li,{children:"t2.2xlarge"}),"\n"]}),"\n",(0,n.jsxs)(i.p,{children:["To modify the size, set the value of ",(0,n.jsx)(i.code,{children:"instance_type"})," in both ",(0,n.jsx)(i.em,{children:"aws-ws.pkrvars.hcl"})," and ",(0,n.jsx)(i.em,{children:"aws-ws.tfvars"}),". For\nexample:"]}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-hcl",children:'instance_type       = "t2.medium"\n'})})]})}function d(e={}){const{wrapper:i}={...(0,a.a)(),...e.components};return i?(0,n.jsx)(i,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},1151:(e,i,s)=>{s.d(i,{Z:()=>l,a:()=>t});var n=s(7294);const a={},r=n.createContext(a);function t(e){const i=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function l(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),n.createElement(r.Provider,{value:i},e.children)}}}]);