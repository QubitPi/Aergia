"use strict";(self.webpackChunkaergia=self.webpackChunkaergia||[]).push([[9231],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),c=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(o.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=c(n),d=r,g=m["".concat(o,".").concat(d)]||m[d]||u[d]||i;return n?a.createElement(g,l(l({ref:t},p),{},{components:n})):a.createElement(g,l({ref:t},p))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=m;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s.mdxType="string"==typeof e?e:r,l[1]=s;for(var c=2;c<i;c++)l[c]=n[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},3355:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var a=n(7462),r=(n(7294),n(3905));const i={sidebar_position:2},l="Elastic Stack (ELK)",s={unversionedId:"elk",id:"elk",title:"Elastic Stack (ELK)",description:"Assuming ELK is a non-frequently deployed tech asset, [Aergia] makes it a semi-automated deployment.",source:"@site/docs/elk.md",sourceDirName:".",slug:"/elk",permalink:"/aergia/docs/elk",draft:!1,editUrl:"https://github.com/QubitPi/aergia/tree/gh-pages/docs/elk.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Aergia Documentation Home",permalink:"/aergia/docs/intro"}},o={},c=[{value:"Setup",id:"setup",level:2},{value:"Get Aergia ELK Deployer",id:"get-aergia-elk-deployer",level:3},{value:"Authenticating to AWS",id:"authenticating-to-aws",level:3},{value:"Preparing for Building AMI Image",id:"preparing-for-building-ami-image",level:3},{value:"Building AMI Image",id:"building-ami-image",level:3},{value:"Preparing for Deploying EC2 Instance",id:"preparing-for-deploying-ec2-instance",level:3},{value:"Deploying EC2 Instance",id:"deploying-ec2-instance",level:3},{value:"Post Setup in EC2 Instance",id:"post-setup-in-ec2-instance",level:3}],p={toc:c};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"elastic-stack-elk"},"Elastic Stack (ELK)"),(0,r.kt)("p",null,"Assuming ELK is a ",(0,r.kt)("em",{parentName:"p"},"non-frequently deployed")," tech asset, ",(0,r.kt)("a",{parentName:"p",href:"https://qubitpi.github.io/aergia/"},"Aergia")," makes it a semi-automated deployment."),(0,r.kt)("h2",{id:"setup"},"Setup"),(0,r.kt)("h3",{id:"get-aergia-elk-deployer"},"Get Aergia ELK Deployer"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"git clone git@github.com:QubitPi/aergia.git\ncd hashicorp/elk\n")),(0,r.kt)("h3",{id:"authenticating-to-aws"},"Authenticating to AWS"),(0,r.kt)("p",null,"Before we can build the AMI, we need to provide our AWS credentials to Packer. These credentials have permissions to\ncreate, modify and delete EC2 instances."),(0,r.kt)("p",null,"To allow Packer to access our IAM user credentials, set our AWS access key ID and secret key as environment variables:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'export AWS_ACCESS_KEY_ID="<YOUR_AWS_ACCESS_KEY_ID>"\nexport AWS_SECRET_ACCESS_KEY="<YOUR_AWS_SECRET_ACCESS_KEY>"\n')),(0,r.kt)("p",null,"In addition, we need to have an ",(0,r.kt)("em",{parentName:"p"},"IAM user")," who has the following ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction_access-management.html"},"AWS permissions policies"),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"AmazonEC2FullAccess")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"AmazonRoute53FullAccess")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"IAMFullAccess"))),(0,r.kt)("h3",{id:"preparing-for-building-ami-image"},"Preparing for Building AMI Image"),(0,r.kt)("p",null,"Create a file named ",(0,r.kt)("strong",{parentName:"p"},"aws-elk.auto.pkrvars.hcl")," at any our preferred location with the following contents:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-hcl"},'aws_image_region           = "us-east-2"\nssl_cert_file_path         = "/absolute/path/to/server.crt"\nssl_cert_key_file_path     = "/absolute/path/to/server.key"\nssl_nginx_config_file_path = "/absolute/path/to/nginx-ssl.conf"\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"aws_image_region")," is the region where ELK AMI will be published to. The published image will be ",(0,r.kt)("em",{parentName:"li"},"private")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"ssl_cert_file_path")," and ",(0,r.kt)("strong",{parentName:"li"},"ssl_cert_key_file_path")," above are the local absolute paths to SSL certificate file and\nSSL certificate key, respectively. They can be ",(0,r.kt)("a",{parentName:"li",href:"https://qubitpi.github.io/aergia/blog/certbot"},"obtained via Certbot")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"ssl_nginx_config_file_path")," is the local absolute path to the Nginx config file (see ",(0,r.kt)("strong",{parentName:"li"},"an example")," below) that\nconsumes the SSL certificate above and enables HTTPS.")),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Here is an example of the aforementioned Nginx config file. Replace ",(0,r.kt)("inlineCode",{parentName:"p"},"my-domain.com")," with the domain backed by the\n",(0,r.kt)("a",{parentName:"p",href:"#ssl-certificate"},"SSL")," accordingly:"),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-text"},"server {\n    listen 80 default_server;\n    listen [::]:80 default_server;\n\n    root /var/www/html;\n\n    index index.html index.htm index.nginx-debian.html;\n\n    server_name _;\n\n    location / {\n        try_files $uri $uri/ =404;\n    }\n}\n\nserver {\n    root /var/www/html;\n\n    index index.html index.htm index.nginx-debian.html;\n    server_name my-domain.com;\n\n    location / {\n        proxy_pass http://localhost:5601;\n    }\n\n    listen [::]:443 ssl ipv6only=on;\n    listen 443 ssl;\n    ssl_certificate /etc/ssl/certs/server.crt;\n    ssl_certificate_key /etc/ssl/private/server.key;\n}\n\nserver {\n    if ($host = my-domain.com) {\n        return 301 https://$host$request_uri;\n    }\n\n    listen 80 ;\n    listen [::]:80 ;\n    server_name my-domain.com;\n    return 404;\n}\n"))),(0,r.kt)("h3",{id:"building-ami-image"},"Building AMI Image"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"packer init .\npacker fmt .\npacker validate .\npacker build --var-file=/absolute/path/to/aforementioned/aws-elk.auto.pkrvars.hcl aws-elk.pkr.hcl\n")),(0,r.kt)("p",null,"Record the ",(0,r.kt)("strong",{parentName:"p"},"Elasticsearch password (for ",(0,r.kt)("em",{parentName:"strong"},"elastic")," user)")," at command line prompt. For example"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"==> install-elk.amazon-ebs.elk: + sudo /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic\n==> install-elk.amazon-ebs.elk: + yes\n    install-elk.amazon-ebs.elk: This tool will reset the password of the [elastic] user to an autogenerated value.\n    install-elk.amazon-ebs.elk: The password will be printed in the console.\n    install-elk.amazon-ebs.elk:\n    install-elk.amazon-ebs.elk:\n    install-elk.amazon-ebs.elk: Password for the [elastic] user successfully reset.\n    install-elk.amazon-ebs.elk: New value: dsrg34IKHU787iud=dio\n")),(0,r.kt)("p",null,"In this case, the password is ",(0,r.kt)("inlineCode",{parentName:"p"},"dsrg34IKHU787iud=dio")," which is shown in the last line of the output above."),(0,r.kt)("p",null,"If we see the following output in the end, if means AMI image has been built successfully:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"==> Wait completed after 5 minutes 40 seconds\n\n==> Builds finished. The artifacts of successful builds are:\n--\x3e install-elk.amazon-ebs.elk: AMIs were created:\n<sensitive>: ami-34gfg45herr356hre43g\n")),(0,r.kt)("h3",{id:"preparing-for-deploying-ec2-instance"},"Preparing for Deploying EC2 Instance"),(0,r.kt)("p",null,"Create a file named ",(0,r.kt)("strong",{parentName:"p"},"aws-elk.auto.tfvars")," at any our preferred location with the following contents:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-hcl"},'aws_deploy_region = "us-east-2"\nzone_id = "<AWS Route 53 Zone ID>"\nelk_doman = "myelk.mycompany.com"\nkey_pair_name = "<AWS keypair name for SSH>"\ninstance_name = "<AWS EC2 displayed instance name>"\nsecurity_group = "<AWS Security Group for the EC2 instance>"\n')),(0,r.kt)("h3",{id:"deploying-ec2-instance"},"Deploying EC2 Instance"),(0,r.kt)("p",null,"Copy the aforementioned ",(0,r.kt)("inlineCode",{parentName:"p"},"aws-elk.auto.tfvars")," file into the ",(0,r.kt)("inlineCode",{parentName:"p"},"aergia/hashicorp/elk/instance")," directory and run"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cd aergia/hashicorp/elk/instance\nterraform init\nterraform apply -auto-approve\n")),(0,r.kt)("h3",{id:"post-setup-in-ec2-instance"},"Post Setup in EC2 Instance"),(0,r.kt)("p",null,"As we've mentioned in the beginning, this is a semi-deployment and we still need to SSH into the box to manually\ngenerate Kibana token & verification code. This will make the automated deploymentl logic simple and easy to maintain"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'sudo /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token --scope kibana --url "https://localhost:9200"\nsudo /usr/share/kibana/bin/kibana-verification-code\n')),(0,r.kt)("p",null,"Now we can visit ",(0,r.kt)("inlineCode",{parentName:"p"},"https://myelk.mycompany.com")," to enter the token and verification code to access our ELK instance."))}u.isMDXComponent=!0}}]);