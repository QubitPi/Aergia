"use strict";(self.webpackChunkhashicorp_aws=self.webpackChunkhashicorp_aws||[]).push([[9414],{8578:(e,i,s)=>{s.r(i),s.d(i,{assets:()=>l,contentTitle:()=>t,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>c});var r=s(4848),n=s(8453);const a={sidebar_position:1,title:"General Deployment"},t=void 0,o={id:"docker-mailserver/index",title:"General Deployment",description:"[//]: # (Copyright Jiaqi Liu)",source:"@site/docs/docker-mailserver/index.md",sourceDirName:"docker-mailserver",slug:"/docker-mailserver/",permalink:"/hashicorp-aws/docs/docker-mailserver/",draft:!1,unlisted:!1,editUrl:"https://github.com/QubitPi/hashicorp-aws/tree/master/docs/docs/docker-mailserver/index.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,title:"General Deployment"},sidebar:"tutorialSidebar",previous:{title:"Docker Mailserver",permalink:"/hashicorp-aws/docs/category/docker-mailserver"},next:{title:"Deployment via Screwdriver CD",permalink:"/hashicorp-aws/docs/docker-mailserver/screwdriver-cd-deployment"}},l={},c=[{value:"General Deployments",id:"general-deployments",level:2},{value:"Defining Packer Variables",id:"defining-packer-variables",level:3},{value:"Defining Terraform Variables",id:"defining-terraform-variables",level:3},{value:"Building AMI Image",id:"building-ami-image",level:3},{value:"Deploying to EC2",id:"deploying-to-ec2",level:3},{value:"Deployment via Screwdriver CD",id:"deployment-via-screwdriver-cd",level:2},{value:"Deployment via HACP",id:"deployment-via-hacp",level:2}];function d(e){const i={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,n.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.h2,{id:"general-deployments",children:"General Deployments"}),"\n",(0,r.jsxs)(i.admonition,{type:"info",children:[(0,r.jsx)(i.p,{children:"Please complete the following two prerequisite setups before preceding"}),(0,r.jsxs)(i.ol,{children:["\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.a,{href:"../setup#setup",children:"general setup"})," (without ",(0,r.jsx)(i.a,{href:"../setup#optional-setup-ssl",children:"SSL setup"}),")"]}),"\n",(0,r.jsx)(i.li,{children:(0,r.jsx)(i.a,{href:"https://qubitpi.github.io/docker-mailserver/edge/usage/#minimal-dns-setup",children:"DNS setup"})}),"\n"]}),(0,r.jsx)(i.h3,{id:"defining-packer-variables",children:"Defining Packer Variables"}),(0,r.jsxs)(i.p,{children:["Create a ",(0,r.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-packer/packer/guides/hcl/variables#from-a-file",children:"HashiCorp Packer variable values file"})," named ",(0,r.jsx)(i.strong,{children:"aws-docker-mailserver.pkrvars.hcl"})," under\n",(0,r.jsx)(i.strong,{children:(0,r.jsx)(i.a,{href:"https://github.com/QubitPi/hashicorp-aws/tree/master/hashicorp/docker-mailserver/images",children:"hashicorp-aws/hashicorp/docker-mailserver/images"})})," with the following contents:"]}),(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-hcl",metastring:'title="hashicorp-aws/hashicorp/docker-mailserver/images/aws-docker-mailserver.auto.pkrvars.hcl"',children:'ami_region          = "us-east-1"\nami_name            = "my-docker-mailserver-ami"\nssl_cert_source     = "/path/to/ssl.crt"\nssl_cert_key_source = "/path/to/ssl.key"\nbase_domain         = "mycompany.com"\n'})}),(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"ami_region"})," is the ",(0,r.jsx)(i.a,{href:"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RegionsAndAvailabilityZones.html#Concepts.RegionsAndAvailabilityZones.Availability",children:"region"})," where docker-mailserver ",(0,r.jsx)(i.a,{href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html",children:"AMI"})," will be published to. The published\nimage will be ",(0,r.jsx)(i.em,{children:"private"})]}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"ami_name"})," is the published ",(0,r.jsx)(i.a,{href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html",children:"AMI"})," name; it can be arbitrary"]}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"ssl_cert_source"})," is the absolute path or the path relative to ",(0,r.jsx)(i.a,{href:"https://github.com/QubitPi/hashicorp-aws/tree/master/hashicorp/docker-mailserver/images",children:"hashicorp-aws/hashicorp/docker-mailserver/images"})," of\nthe ",(0,r.jsx)(i.a,{href:"../setup#optional-setup-ssl",children:"SSL certificate file"})," for the domain serving the docker-mailserver EC2 instance"]}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"ssl_cert_key_source"}),"  is the absolute path or the path relative to\n",(0,r.jsx)(i.a,{href:"https://github.com/QubitPi/hashicorp-aws/tree/master/hashicorp/docker-mailserver/images",children:"hashicorp-aws/hashicorp/docker-mailserver/images"})," of the ",(0,r.jsx)(i.a,{href:"../setup#optional-setup-ssl",children:"SSL certificate key file"})," for\nthe domain serving the docker-mailserver EC2 instance"]}),"\n",(0,r.jsx)(i.admonition,{type:"info",children:(0,r.jsxs)(i.p,{children:["hashicorp-aws ",(0,r.jsx)(i.a,{href:"https://qubitpi.github.io/docker-mailserver/edge/config/security/ssl/",children:"supports SSL"})," with the\n",(0,r.jsx)(i.a,{href:"https://qubitpi.github.io/docker-mailserver/edge/config/security/ssl/#bring-your-own-certificates",children:"Bring Your Own Certificates"})," option"]})}),"\n"]}),"\n"]})]}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"base_domain"})," is the base domain name of the MX record. For example, if base domain is 'mycompany.com', the generated\nMX record will be 'mail.mycompany.com'"]}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:["(Optional) ",(0,r.jsx)(i.code,{children:"instance_type"}),": is the ",(0,r.jsx)(i.a,{href:"https://aws.amazon.com/ec2/instance-types/",children:"AWS EC2 instance type"}),' building this image. hashicorp-aws uses "t2.micro" as\ndefault value if this value is unspecified']}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(i.h3,{id:"defining-terraform-variables",children:"Defining Terraform Variables"}),"\n",(0,r.jsxs)(i.p,{children:["Create a ",(0,r.jsx)(i.a,{href:"https://qubitpi.github.io/hashicorp-terraform/terraform/language/values/variables#variable-definitions-tfvars-files",children:"HashiCorp Terraform variable values file"})," named ",(0,r.jsx)(i.strong,{children:"aws-docker-mailserver.tfvars"})," under\n**",(0,r.jsx)(i.a,{href:"https://github.com/QubitPi/hashicorp-aws/tree/master/hashicorp/docker-mailserver/instances",children:"hashicorp-aws/hashicorp/docker-mailserver/instances"}),"**with the following contents:"]}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-hcl",metastring:'title="hashicorp-aws/hashicorp/docker-mailserver/instances/aws-docker-mailserver.auto.tfvars"',children:'aws_deploy_region    = "us-east-1"\nami_name             = "my-docker-mailserver-ami"\ninstance_name        = "My docker-mailserver instance"\nkey_pair_name        = "My SSH keypair name"\nsecurity_groups      = ["My docker-mailserver Security Group"]\nbase_domain          = "mycompany.com"\nroute_53_zone_id     = "9DQXLTNSN7ZX9P8V2KZII"\nfirst_email          = "jack@mycompany.com"\nfirst_email_password = "sdfeo9uig&^&rf8u"\n'})}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"aws_deploy_region"})," is the ",(0,r.jsx)(i.a,{href:"https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RegionsAndAvailabilityZones.html#Concepts.RegionsAndAvailabilityZones.Availability",children:"EC2 runtime region"})," where docker-mailserver EC2 instance will be deployed\ninto"]}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"ami_name"})," is the name of the published AMI; ",(0,r.jsxs)(i.strong,{children:["it must be the same as the ",(0,r.jsx)(i.code,{children:"ami_name"})," in\n",(0,r.jsx)(i.a,{href:"#defining-packer-variables",children:"Packer variable file"})]})]}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"instance_name"})," is the deployed EC2 name as appeared in the instance list of AWS console; it can be arbitrary"]}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"key_pair_name"})," is the name of\n",(0,r.jsx)(i.a,{href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html",children:"AWS EC2 key pair"})," bound to this docker-mailserver instance. We can use this key pair to later ssh into the instance\nfor admin management purposes"]}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"security_groups"})," is the list of ",(0,r.jsx)(i.a,{href:"https://docs.aws.amazon.com/vpc/latest/userguide/vpc-security-groups.html",children:"AWS Security Group"})," ",(0,r.jsx)(i.em,{children:"names"})," to associate with (yes, not ID, but name...)"]}),"\n",(0,r.jsx)(i.admonition,{type:"tip",children:(0,r.jsxs)(i.p,{children:["The security group must open all the ports mentioned ",(0,r.jsx)(i.a,{href:"https://qubitpi.github.io/docker-mailserver/edge/config/security/understanding-the-ports/#overview-of-email-ports",children:"docker-mailserver's documentation"})]})}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"base_domain"})," is the base domain name of the MX record. For example, if base domain is 'mycompany.com', the generated\nMX record will be 'mail.mycompany.com'"]}),"\n",(0,r.jsx)(i.admonition,{type:"note",children:(0,r.jsxs)(i.p,{children:["hashicorp-aws will bind a ",(0,r.jsx)(i.em,{children:"private"})," IP address to this domain because\n",(0,r.jsx)(i.a,{href:"https://serverfault.com/a/967483",children:"AWS security groups works for private IP only for DNS resolving"}),"."]})}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"route_53_zone_id"}),' is the AWS Route 53 hosted Zone ID that hosts the domain "mail.mycompany.com"']}),"\n",(0,r.jsxs)(i.admonition,{type:"tip",children:[(0,r.jsx)(i.p,{children:"To find the zone ID in AWS Route 53, we can:"}),(0,r.jsxs)(i.ol,{children:["\n",(0,r.jsx)(i.li,{children:"Sign in to the AWS Management Console"}),"\n",(0,r.jsxs)(i.li,{children:["Open the Route 53 console at ",(0,r.jsx)(i.a,{href:"https://console.aws.amazon.com/route53/",children:"https://console.aws.amazon.com/route53/"})]}),"\n",(0,r.jsx)(i.li,{children:"Select Hosted zones in the navigation pane"}),"\n",(0,r.jsx)(i.li,{children:"Find the requested ID in the top level Hosted Zones summary in the Route 53 section"}),"\n"]})]}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"first_email"})," is the email used for mail server startup."]}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"first_email_password"})," is the password of the email for mail server startup"]}),"\n",(0,r.jsx)(i.admonition,{type:"tip",children:(0,r.jsx)(i.p,{children:"On first start, we will need to add at least one email account. The provided first email will be used for that and\ncan be used for sending/receiving emails immediately after deployment"})}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:["\n",(0,r.jsxs)(i.p,{children:["(Optional) ",(0,r.jsx)(i.code,{children:"instance_type"}),": is the ",(0,r.jsx)(i.a,{href:"https://aws.amazon.com/ec2/instance-types/",children:"AWS EC2 instance type"}),' running the EC2 instance. hashicorp-aws uses "t2.micro" as\ndefault value if this value is unspecified']}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(i.h3,{id:"building-ami-image",children:"Building AMI Image"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-console",children:'cd hashicorp-aws/hashicorp/docker-mailserver/images\npacker init .\npacker validate -var "skip_create_ami=true" .\npacker build -var "skip_create_ami=false" .\n'})}),"\n",(0,r.jsx)(i.h3,{id:"deploying-to-ec2",children:"Deploying to EC2"}),"\n",(0,r.jsx)(i.admonition,{type:"caution",children:(0,r.jsxs)(i.p,{children:["Depending on the ",(0,r.jsx)(i.a,{href:"#defining-packer-variables",children:"AMI"})," and ",(0,r.jsx)(i.a,{href:"#defining-terraform-variables",children:"EC2"})," configs, ",(0,r.jsx)(i.strong,{children:"please be aware\nAWS credit charges shall incur after the following commands execute"})]})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-console",children:"cd ../instances/\nterraform init\nterraform validate\nterraform apply -auto-approve\n"})}),"\n",(0,r.jsx)(i.h2,{id:"deployment-via-screwdriver-cd",children:"Deployment via Screwdriver CD"}),"\n",(0,r.jsxs)(i.p,{children:["hashicorp-aws supports deployment using ",(0,r.jsx)(i.a,{href:"screwdriver-cd-deployment",children:"Screwdriver CD"}),". Please check it out. ",(0,r.jsx)("img",{src:"https://github.com/QubitPi/QubitPi/blob/master/img/8%E5%A5%BD.gif?raw=true",height:"40px"})]}),"\n",(0,r.jsx)(i.h2,{id:"deployment-via-hacp",children:"Deployment via HACP"}),"\n",(0,r.jsx)(i.admonition,{type:"tip",children:(0,r.jsx)(i.p,{children:"Please try our HACP platform to deploy a docker-mailserver instance. It gives us one-click experience that helps us\nstand up docker-mailserver in a minute."})})]})}function h(e={}){const{wrapper:i}={...(0,n.R)(),...e.components};return i?(0,r.jsx)(i,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,i,s)=>{s.d(i,{R:()=>t,x:()=>o});var r=s(6540);const n={},a=r.createContext(n);function t(e){const i=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function o(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:t(e.components),r.createElement(a.Provider,{value:i},e.children)}}}]);