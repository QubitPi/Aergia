# Copyright Jiaqi Liu
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
namespace: QubitPi
name: sonatype-nexus-repository-release-definition-template
version: '1.0.0'
description: |
  Screwdriver CD template for deploying Sonatype Nexus Repository (https://github.com/QubitPi/docker-nexus3) to AWS
  through HashiCorp.
maintainer: jack20220723@gmail.com
config:
  template: QubitPi/hashicorp-aws-ssl-release-definition-template
  order: [
    install-packer,
    install-terraform,
    checkout-hashicorp-deployment-tool,
    load-packer-variable-file,
    load-terraform-variable-file,
    packer-init,
    packer-validate,
    packer-build,
    terraform-init,
    terraform-validate,
    terraform-apply
  ]
  steps:
    - postload-packer-variable-file: |
        echo sonatype_nexus_repository_domain = \"$(meta get parameters.domain.value)\"              >> $HASHICORP_AWS_INFRASTRUCTURE_DIR/images/aws.auto.pkrvars.hcl
        echo ssl_cert_base64                  = \"$(meta get parameters.ssl-cert-base64.value)\"     >> $HASHICORP_AWS_INFRASTRUCTURE_DIR/images/aws.auto.pkrvars.hcl
        echo ssl_cert_key_base64              = \"$(meta get parameters.ssl-cert-key-base64.value)\" >> $HASHICORP_AWS_INFRASTRUCTURE_DIR/images/aws.auto.pkrvars.hcl
    - postload-terraform-variable-file: |
        echo domain           = \"$(meta get parameters.domain.value)\"           >> $HASHICORP_AWS_INFRASTRUCTURE_DIR/instances/aws.auto.tfvars
        echo route_53_zone_id = \"$(meta get parameters.route-53-zone-id.value)\" >> $HASHICORP_AWS_INFRASTRUCTURE_DIR/instances/aws.auto.tfvars

  environment:
    HASHICORP_AWS_INFRASTRUCTURE_DIR: ../hashicorp-aws/hashicorp/sonatype-nexus-repository
